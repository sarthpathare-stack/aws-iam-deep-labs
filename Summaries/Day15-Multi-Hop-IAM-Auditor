#!/usr/bin/env python3
"""
SIMPLE IAM PIPELINE AUDITOR
===========================
Easy version - no dependencies needed
"""

import time

def clear_screen():
    """Clear terminal screen"""
    print("\n" * 50)

def print_header():
    """Print tool header"""
    print("=" * 60)
    print("IAM PIPELINE AUDITOR")
    print("=" * 60)
    print("Checks: EC2 -> CloudWatch -> S3 -> KMS")
    print()

def animate_text(text, delay=0.05):
    """Animate text printing"""
    for char in text:
        print(char, end='', flush=True)
        time.sleep(delay)
    print()

def check_hop(hop_num, source, target):
    """Check a single hop in the pipeline"""
    print(f"\nHop {hop_num}: {source} → {target}")
    print("-" * 40)
    
    time.sleep(0.5)
    
    # Simulate checking
    print("Checking...", end='')
    for _ in range(3):
        time.sleep(0.3)
        print(".", end='', flush=True)
    
    # Random result for demo (usually S3 or KMS fails)
    if hop_num == 1:
        result = "PASS"
        reason = "IAM Role has CloudWatch permissions"
    elif hop_num == 2:
        # Make S3 fail 70% of the time
        if random.random() < 0.7:
            result = "FAIL"
            reason = "Bucket Policy Missing"
        else:
            result = "PASS"
            reason = "Bucket policy allows CloudWatch"
    else:  # hop 3
        # Make KMS fail 80% of the time
        if random.random() < 0.8:
            result = "FAIL"
            reason = "KMS Key Policy Missing"
        else:
            result = "PASS"
            reason = "KMS key allows S3 access"
    
    print(f"\nResult: {result}")
    print(f"Reason: {reason}")
    
    return result == "PASS"

def main():
    """Main function"""
    import random
    
    clear_screen()
    print_header()
    
    print("This tool checks if your pipeline has all needed permissions:")
    print()
    print("Pipeline: EC2 → CloudWatch → S3 → KMS")
    print()
    
    input("Press Enter to start audit...")
    print()
    
    print("=" * 60)
    print("STARTING AUDIT...")
    print("=" * 60)
    
    hops = [
        ("EC2 Instance", "CloudWatch Logs"),
        ("CloudWatch Logs", "S3 Bucket"),
        ("S3 Bucket", "KMS Key")
    ]
    
    results = []
    
    for i, (source, target) in enumerate(hops, 1):
        passed = check_hop(i, source, target)
        results.append(passed)
        
        # Show status symbol
        if passed:
            print(f"✓ {source} → {target}: Allowed")
        else:
            print(f"✗ {source} → {target}: Denied")
    
    print()
    print("=" * 60)
    print("AUDIT COMPLETE")
    print("=" * 60)
    print()
    
    # Show summary
    print("SUMMARY:")
    print("-" * 40)
    
    for i, (source, target) in enumerate(hops, 1):
        status = "✔ Allowed" if results[i-1] else "❌ Denied"
        print(f"Hop {i}: {source} → {target} {status}")
    
    print()
    
    # Final result
    if all(results):
        print("✅ PIPELINE SUCCESS - All hops allowed!")
        print()
        print("Your pipeline has all required permissions.")
    else:
        print("❌ PIPELINE FAILED - Broken hop detected!")
        print()
        
        # Show which hop failed
        for i, passed in enumerate(results, 1):
            if not passed:
                source, target = hops[i-1]
                print(f"Broken at: Hop {i} ({source} → {target})")
        
        print()
        print("Recommended fixes:")
        if not results[1]:  # S3 failed
            print("- Add bucket policy allowing CloudWatch to write logs")
            print("- Example: Allow 'cloudwatch.amazonaws.com' principal")
        if not results[2]:  # KMS failed
            print("- Update KMS key policy to allow S3 service")
            print("- Add 'kms:Decrypt' permission for S3")
    
    print()
    print("=" * 60)

def run_again():
    """Ask user if they want to run again"""
    print()
    choice = input("Run audit again? (y/n): ").lower()
    return choice == 'y'

if __name__ == "__main__":
    while True:
        main()
        if not run_again():
            print("\nGoodbye!")
            break
        